<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordlink Post Detail</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to ensure the container scales nicely */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align content to the top */
            background-color: #f7f9fb;
        }

        .post-section {
            width: 100%;
            max-width: 600px;
            padding: 1rem;
            margin-top: 2rem; /* Add margin to look centered on screen */
        }

        .post-content-full {
            /* For the full content state */
            display: block;
            overflow: visible;
            max-height: none;
        }

        .post-content-collapsed {
            /* For the collapsed state (limit to 4 lines) */
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Base SVG icon styling to make them clickable/visible */
        .icon-btn {
            transition: color 0.2s, transform 0.1s;
        }
        .icon-btn:hover {
            color: #1d9bf0; /* Twitter Blue */
            transform: scale(1.05);
        }
        .like-btn.liked {
            fill: #ef4444; /* Red for liked state */
            stroke: #ef4444;
        }
        .like-btn:hover {
             fill: #fca5a5; /* Lighter red on hover */
             stroke: #fca5a5;
        }
    </style>
</head>
<body>
    <div class="post-section" id="post-container">
        <!-- Content will be rendered here -->
        <div class="text-center p-8 text-gray-500">Loading post...</div>
    </div>

    <script>

        // Global state for simplicity in a single-file demo
        let currentPost = null;
        
        let contentTruncated = true; // Default to truncated view
        let contentClass = 'post-content-collapsed';

        /**
         * Simulates fetching a post, updates the global state, and renders.
         */
        async function fetchAndRenderPost(postId) {
            const container = document.getElementById('post-container');
            
            const res = await fetch(`http://localhost:2345/api/posts/${postId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${localStorage.getItem('token')}`,
                },
            });

            currentPost = await res.json();

            renderPost(container);
        }

        /**
         * Renders the post content into the container.
         */
        function renderPost(container) {
            if (!currentPost) {
                container.innerHTML = `<div class="text-center p-8 text-red-500">Post not found.</div>`;
                return;
            }

            // Determine content class for truncation
            
            
            const content = document.getElementById('post-text')
            if (content){
              contentClass = content.length > 300 && contentTruncated 
                ? 'post-content-collapsed' 
                : 'post-content-full';
            
            }
            // Format date for display
            const formattedDate = new Date(currentPost.updatedAt).toLocaleString('en-US', { 
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
            });


            container.innerHTML = `
            <div class="comment flex fixed bottom-5 left-1/2 transform -translate-x-1/2 w-11/12 max-w-lg bg-white p-4 rounded-lg shadow-lg border border-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 grey">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Z" />
                </svg>
                <textarea class="flex max-h-5 h-3 rounded-sm ml-3 p-4 overflow-y-hidden place-content-end border border-transparent colors-blue-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent focus:outline-none" placeholder="Enter comment"></textarea>
            </div>
                <div class="post-card bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition duration-300" data-id="${currentPost._id}">
                    
                    <!-- Header & Profile -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center">
                            <img src="${currentPost.profilePic}" onerror="this.onerror=null; this.src='https://placehold.co/50x50/334155/ffffff?text=User';" alt="${currentPost.fullname} profile" class="w-12 h-12 rounded-full mr-3 shadow-md border-2 border-white" />
                            <div class="text-sm">
                                <span class="block font-bold text-gray-900">${currentPost.fullname}</span>
                                <span class="block text-gray-500 text-xs">${currentPost.username}</span>
                            </div>
                        </div>

                        <!-- Dropdown Menu (Simplified for demo) -->
                        <div class="relative group">
                            <svg class="w-6 h-6 text-gray-400 hover:text-gray-700 cursor-pointer icon-btn" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
                            </svg>
                            <!-- Mock Dropdown List -->
                            <ul class="absolute right-0 top-6 mt-1 w-48 bg-white border border-gray-200 rounded-lg shadow-xl hidden group-hover:block z-10">
                                <li><button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg" onclick="handleFollow('${currentPost.username}')">${null? 'Unfollow' : 'Follow'} ${currentPost.username}</button></li>
                                ${currentPost.isUserPost ? `<li><button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" onclick="editPost('${currentPost._id}')">Edit Post</button></li>` : ""}
                                ${currentPost.isUserPost ? `<li><button class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-b-lg" onclick="showdeleteModal('${currentPost._id}')">Delete Post</button></li>` : ""}
                                
                            </ul>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="post-body">
                        <p class="text-gray-800 leading-relaxed text-base mb-3 ${contentClass}" id="post-text">${currentPost.content}</p>
                        
                        <!-- Read More Button -->
                        ${currentPost.content.length > 300 ? `
                            <button onclick="toggleReadMore()" class="text-blue-500 hover:text-blue-700 text-sm font-medium mb-3">
                                ${contentTruncated ? 'Read More' : 'Read Less'}
                            </button>` 
                        : ""}
                        
                        <!-- Image -->
                        ${currentPost.imageUrl ? `<img src="${currentPost.imageUrl}" onerror="this.onerror=null; this.src='https://placehold.co/600x400/94a3b8/ffffff?text=Image+Unavailable';" alt="Post image" class="w-full h-auto rounded-lg mt-3 shadow-md" />` : ""}
                        
                        <!-- Date -->
                        ${currentPost.updatedAt ? `<div class="text-gray-400 text-xs mt-3">${formattedDate}</div>`: ""}
                    </div>

                    <!-- Footer / Interaction Bar -->
                    <div class="flex justify-between items-center pt-4 mt-4 border-t border-gray-100">
                        <div class="flex space-x-6">
                            <!-- Like Button -->
                            <button onclick="toggleLike('${currentPost._id}')" class="flex items-center space-x-1 text-gray-500 hover:text-red-500 transition duration-150">
                                <svg id="like-btn" 
                                    class="w-6 h-6 icon-btn like-btn ${currentPost.isLiked ? 'liked' : ''}" 
                                    xmlns="http://www.w3.org/2000/svg" 
                                    viewBox="0 0 24 24" 
                                    stroke-width="1.5" 
                                    stroke="${currentPost.isLiked ? 'red' : 'currentColor'}"
                                    fill="${currentPost.isLiked ? 'red' : 'none'}">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
                                </svg>
                                <span class="text-sm font-medium">${currentPost.likes}</span>
                            </button>

                            <!-- Comment Button -->
                            <button onclick="openPost('${currentPost._id}')" class="flex items-center space-x-1 text-gray-500 hover:text-blue-500 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 icon-btn">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
                                </svg>
                                <span class="text-sm font-medium">${currentPost.comments.length}</span>
                            </button>

                            <!-- Repost/Share Button -->
                            <button class="flex items-center space-x-1 text-gray-500 hover:text-green-500 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 icon-btn">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.017.22-.032.441-.046.662M19.5 12l3-3m-3 3-3-3m-12 3c0 1.232.046 2.453.138 3.662a4.006 4.006 0 0 0 3.7 3.7 48.656 48.656 0 0 0 7.324 0 4.006 4.006 0 0 0 3.7-3.7c.017-.22.032-.441.046-.662M4.5 12l3 3m-3-3-3 3" />
                                </svg>
                                <span class="text-sm font-medium">0</span> <!-- Mock shares -->
                            </button>
                        </div>

                        <!-- Save/Bookmark Button -->
                        <button class="text-gray-500 hover:text-yellow-500 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 icon-btn">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Toggles the like status of the post and re-renders.
         */
        function toggleLike(postId) {
            if (!currentPost || currentPost._id !== postId) return;
            
            currentPost.isLiked = !currentPost.isLiked;
            currentPost.likes += currentPost.isLiked ? 1 : -1;

            const likeBtn = document.querySelector('.post-card .like-btn');
            const likesCount = document.querySelector('.post-card .likes');

            if (likeBtn) {
                if (currentPost.isLiked) {
                    likeBtn.classList.add('liked');
                    likeBtn.setAttribute('fill', 'red');
                    likeBtn.setAttribute('stroke', 'red');
                } else {
                    likeBtn.classList.remove('liked');
                    likeBtn.setAttribute('fill', 'none');
                    likeBtn.setAttribute('stroke', 'currentColor');
                }
            }
            if (likesCount) {
                likesCount.textContent = currentPost.likes;
            }
        }

        /**
         * Toggles the content between truncated and full view.
         */
        function toggleReadMore() {
            if (!currentPost) return;
            const postText = document.getElementById('post-text');
            const readMoreBtn = postText.nextElementSibling; // The button immediately following the content

            if (postText) {
                postText.classList.toggle('post-content-collapsed', currentPost.contentTruncated);
                postText.classList.toggle('post-content-full', !currentPost.contentTruncated);
            }

            if (readMoreBtn && readMoreBtn.tagName === 'BUTTON') {
                readMoreBtn.textContent = currentPost.contentTruncated ? 'Read More' : 'Read Less';
            }
        }

        /**
         * Placeholder for opening the post detail/comment page.
         */
        function openPost(postId) {
            // In a multi-page app, this would be a redirect: window.location.href = `/post/${postId}`;
        }

        /**
         * Placeholder for the follow/unfollow logic.
         */
        function handleFollow(username) {
            // Re-render to update the dropdown button text
            fetchAndRenderPost(currentPost._id); 
        }

        /**
         * Placeholder for the edit action.
         */
        function editPost(postId) {
             console.log(`Opening edit modal for post: ${postId}`);
             // In a real app, open a modal with the post data for editing.
        }

        /**
         * Placeholder for showing a delete confirmation modal.
         */
        function showdeleteModal(postId) {
             console.log(`Showing confirmation modal to delete post: ${postId}`);
             // Use a custom modal UI here, as 'confirm()' is forbidden.
        }

        /**
         * Placeholder for the share action (e.g., copy link or open share sheet).
         */
        function sharePost(postId) {
            const urlToShare = `https://your-app.com/post/${postId}`;
            // Use execCommand('copy') for cross-browser compatibility in iFrames
            const input = document.createElement('input');
            input.value = urlToShare;
            document.body.appendChild(input);
            input.select();
            
            try {
                document.execCommand('copy');
                alertMessage(`Link copied to clipboard!`, 'success');
            } catch (err) {
                alertMessage(`Could not copy link.`, 'error');
            }
            document.body.removeChild(input);
            console.log(`Sharing URL: ${urlToShare}`);
        }

        /**
         * Custom message box (since alert() is forbidden).
         */
        function alertMessage(message, type) {
            let existingAlert = document.getElementById('custom-alert');
            if (existingAlert) { existingAlert.remove(); }
            
            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = `fixed top-5 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-xl text-white font-semibold z-50 transition-opacity duration-300`;
            alertDiv.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444'; // green or red
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }

        // Initialize the app on page load
        window.onload = function() {
            // For a complete demo, we'll just use the mock ID. 
            // The original logic of getting from sessionStorage is commented out.
            // const postId = || MOCK_POST._id;
            const postId = sessionStorage.getItem('currentPostId');
            fetchAndRenderPost(postId);
        };

        window.onresize = function() {
            if (window.innerWidth < 1024) {
                // If resized to mobile, remove the iframe and go back to main view
                sessionStorage.removeItem("currentPostId");
                window.location.href = 'clients.html'; // or the main page
            }
        };
    </script>
</body>
</html>