<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wordlink || Sign Up</title>
    <link rel="icon" href="./images/icon.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: 'Inter', sans-serif;
        background: #f3f4f6;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .form-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 24px;
        padding: 40px;
        width: 100%;
        max-width: 420px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden; /* Clips the sliding pages */
        position: relative;
      }

      .logo { text-align: center; margin-bottom: 24px; }
      .logo img { width: 50px; height: 50px; }

      .progress-bar { display: flex; gap: 8px; margin-bottom: 32px; }
      .progress-step {
        height: 4px; flex: 1;
        background: rgba(10, 132, 255, 0.1);
        border-radius: 2px;
        transition: all 0.3s ease;
      }
      .progress-step.active { background: linear-gradient(135deg, #0A84FF 0%, #0070e0 100%); }

      /* Carousel Styling */
      .carousel-wrapper { overflow: hidden; width: 100%; }
      .carousel {
        display: flex;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        width: 300%;
      }
      .carousel-page {
        width: 33.333%;
        flex-shrink: 0;
        padding: 0 5px;
      }

      h2 { font-size: 24px; font-weight: 700; color: #1a1a1a; margin-bottom: 8px; }
      .subtitle { color: #6b7280; font-size: 14px; margin-bottom: 24px; }
      .input-group { margin-bottom: 20px; }
      
      input {
        width: 100%; padding: 16px 20px;
        border: 2px solid #e5e7eb; border-radius: 16px;
        font-size: 16px; transition: all 0.3s ease; outline: none;
      }
      input:focus { border-color: #0A84FF; box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.1); }

      .fullname { display: flex; gap: 12px; margin-bottom: 20px; }
      .helper-text { font-size: 12px; color: #6b7280; margin-top: 8px; }

      button {
        width: 100%; padding: 16px;
        background: linear-gradient(135deg, #0A84FF 0%, #0070e0 100%);
        border: none; border-radius: 16px; color: white;
        font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
      }
      button:disabled { opacity: 0.6; cursor: not-allowed; }

      .btn-group { display: flex; gap: 12px; margin-top: 16px; }
      .btn-secondary { background: #f3f4f6; color: #6c757d; border: 2px solid #e5e7eb; }

      .msg {
        text-align: center; margin-top: 16px; padding: 12px;
        border-radius: 12px; font-size: 14px; min-height: 45px;
      }
      .msg.error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
      .msg.success { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }

      .profile-upload { display: flex; flex-direction: column; align-items: center; gap: 15px; }
      .profile-preview {
        width: 110px; height: 110px; border-radius: 50%;
        border: 3px solid #0A84FF; display: flex; align-items: center;
        justify-content: center; background: #f9fafb; overflow: hidden;
      }
      .profile-preview img { width: 100%; height: 100%; object-fit: cover; }
      
      #loader { display: none; align-items: center; justify-content: center; gap: 10px; margin-top: 15px; }
      .spinner {
        width: 20px; height: 20px; border: 2px solid #0A84FF;
        border-radius: 50%; border-top-color: transparent; animation: spin 0.8s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }

      .login-link { text-align: center; margin-top: 24px; font-size: 14px; color: #6b7280; }
      .login-link a { color: #0A84FF; text-decoration: none; font-weight: 600; }

      @media (max-width: 480px) { .fullname { flex-direction: column; } }
    </style>
  </head>
  <body>
    <div class="form-container">
      <div class="logo"><img src="./images/icon2.png" alt="WordLink"></div>
      
      <div class="progress-bar">
        <div class="progress-step active"></div>
        <div class="progress-step"></div>
        <div class="progress-step"></div>
      </div>

      <form id="signupForm">
        <div class="carousel-wrapper">
          <div class="carousel" id="carousel">
            <div class="carousel-page">
              <h2>Create Account</h2>
              <p class="subtitle">Join WordLink today</p>
              <div class="fullname">
                <input type="text" id="firstname" placeholder="First Name" required />
                <input type="text" id="lastname" placeholder="Last Name" required />
              </div>
              <div class="input-group"><input type="text" id="username" placeholder="@username" required /></div>
              <div class="input-group"><input type="email" id="email" placeholder="Email" required /></div>
              <div class="input-group"><input type="password" id="password" placeholder="Password" required /></div>
              <div class="input-group"><input type="password" id="confirmPassword" placeholder="Confirm Password" required /></div>
              <button type="button" id="nextBtn1">Continue</button>
              <div class="msg" id="msg1"></div>
            </div>

            <div class="carousel-page">
              <h2>Date of Birth</h2>
              <p class="subtitle">We need your age for security</p>
              <div class="fullname">
                <input type="number" id="day" placeholder="DD" min="1" max="31" />
                <input type="number" id="month" placeholder="MM" min="1" max="12" />
                <input type="number" id="year" placeholder="YYYY" min="1900" max="2024" />
              </div>
              <div class="btn-group">
                <button type="button" class="btn-secondary" id="backBtn1">Back</button>
                <button type="button" id="nextBtn2">Continue</button>
              </div>
              <div class="msg" id="msg2"></div>
            </div>

            <div class="carousel-page">
              <h2>Profile Picture</h2>
              <p class="subtitle">Add a photo to personalize your profile</p>
              <div class="profile-upload">
                <div class="profile-preview" id="profilePreview">ðŸ“¸</div>
                <input type="file" id="profilePic" accept="image/*" />
              </div>
              <div class="btn-group">
                <button type="button" class="btn-secondary" id="backBtn2">Back</button>
                <button type="submit" id="submitBtn">Create Account</button>
              </div>
              <div id="loader"><div class="spinner"></div> Creating account...</div>
              <div class="msg" id="msg3"></div>
            </div>
          </div>
        </div>
      </form>
      
      <div class="login-link">Already have an account? <a href="login.html">Sign in</a></div>
    </div>

    <script>
      let currentPage = 0;
      const carousel = document.getElementById("carousel");
      const progressSteps = document.querySelectorAll(".progress-step");
      const formData = { firstname: "", lastname: "", username: "", email: "", password: "", dob: "", profilePic: null };

      // Helper for Carousel Navigation
      function goToPage(pageNum) {
        currentPage = pageNum;
        carousel.style.transform = `translateX(-${pageNum * (100/3)}%)`;
        progressSteps.forEach((step, i) => step.classList.toggle("active", i <= pageNum));
      }

      function showMessage(msgId, text, isError = true) {
        const msg = document.getElementById(msgId);
        msg.textContent = text;
        msg.className = text ? (isError ? "msg error" : "msg success") : "msg";
      }

      // Check Username/Email availability
      async function checkAvailability(endpoint, payload, msgId, btnId) {
        try {
          const res = await fetch(`https://wordlinkapp.onrender.com/api/auths/${endpoint}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok) {
            showMessage(msgId, data.message);
            document.getElementById(btnId).disabled = true;
          } else {
            showMessage(msgId, "");
            document.getElementById(btnId).disabled = false;
          }
        } catch (e) { console.error(e); }
      }

      document.getElementById("username").addEventListener("blur", (e) => {
        if(e.target.value) checkAvailability("check", { username: e.target.value }, "msg1", "nextBtn1");
      });

      document.getElementById("email").addEventListener("blur", (e) => {
        if(e.target.value) checkAvailability("check-email", { email: e.target.value }, "msg1", "nextBtn1");
      });

      // Page 1 Logic
      document.getElementById("nextBtn1").addEventListener("click", () => {
        const pass = document.getElementById("password").value;
        const confirm = document.getElementById("confirmPassword").value;
        if (pass !== confirm) return showMessage("msg1", "Passwords do not match");
        if (pass.length < 8) return showMessage("msg1", "Password too short");

        formData.firstname = document.getElementById("firstname").value;
        formData.lastname = document.getElementById("lastname").value;
        formData.username = document.getElementById("username").value;
        formData.email = document.getElementById("email").value;
        formData.password = pass;
        
        goToPage(1);
      });

      // Page 2 Logic
      document.getElementById("nextBtn2").addEventListener("click", () => {
        const d = document.getElementById("day").value;
        const m = document.getElementById("month").value;
        const y = document.getElementById("year").value;
        if(!d || !m || !y) return showMessage("msg2", "Complete your birth date");
        
        formData.dob = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        goToPage(2);
      });

      document.getElementById("backBtn1").addEventListener("click", () => goToPage(0));
      document.getElementById("backBtn2").addEventListener("click", () => goToPage(1));

      // Image Preview
      document.getElementById("profilePic").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          formData.profilePic = file;
          const reader = new FileReader();
          reader.onload = (e) => document.getElementById("profilePreview").innerHTML = `<img src="${e.target.result}">`;
          reader.readAsDataURL(file);
        }
      });

      // Final Submission & Email Verification Concept
      document.getElementById("signupForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        // Save to localStorage for the verification page to access
        const uploadData = new FormData();
        Object.keys(formData).forEach(key => uploadData.append(key, formData[key]));
        
        // Convert FormData to object for storage (Note: Files cannot be easily stored in localStorage as strings)
        const storageObj = { ...formData, profilePic: null }; 
        localStorage.setItem("signupData", JSON.stringify(storageObj));
        sessionStorage.setItem("userEmail", formData.email);

        // Redirect to verification
        window.location.href = "verifyEmail.html";
      });

      // Handling the "Return from Verification" logic
      window.onload = () => {
        if (sessionStorage.getItem("isVerified") === "true") {
          submitFinalData();
        }
      };

      async function submitFinalData() {
        const loader = document.getElementById("loader");
        loader.style.display = "flex";
        const stored = JSON.parse(localStorage.getItem("signupData"));
        
        const finalForm = new FormData();
        for (let key in stored) finalForm.append(key, stored[key]);

        try {
          const res = await fetch("https://wordlinkapp.onrender.com/api/auths/signup", {
            method: "POST",
            body: finalForm
          });
          if (res.ok) {
            window.location.href = "login.html";
          } else {
            const data = await res.json();
            showMessage("msg3", data.message);
          }
        } catch (err) {
          showMessage("msg3", "Server error. Try again.");
        } finally {
          loader.style.display = "none";
        }
      }
    </script>
  </body>
                                                                                                                </html>
                  
